# api-notify
## 写在前面
本仓库使用百度的 comate（外部名称为文心快码）实现了一个稳定、可靠的api通知系统，
旨在解决在微服务架构中，如何高效、可靠地通知合作伙伴或外部系统关于业务事件的问题。

考虑到本次考试的本意，本仓库代码基本上全部由AI生成，人工仅仅是处理了代码库依赖问题，
确保程序可以编译，整体用时约为2个小时左右。

## 最初的想法
首先，设计一个接口获取api请求的相关信息，包括：
1. request_id: 请求 id，要求唯一（可以使用 uuid），用于接口幂等处理
2. partner_id: 合作方标识,用于区分不同的合作伙伴
3. endpoints: 合作方的连接参数数组，数组元素包括 ip 和 port
4. headers: api 请求的 head 信息
5. body: api 请求的 body 信息

这里简化了参数处理，假定所有的 api 请求的方法都是 post。

然后，设计一个数据库表，除了存储 api 的参数字段，还加上一个自增的 id 作为主键，
以及一个 status 字段表示 api 请求当前的状态，同时将 request_id 设置为唯一键。
当请求接口时，将参数存入数据库，并设置 status 为 new。通过 request_id 的唯一性
实现接口的幂等功能。完成数据库操作后接口即可返回。

最后程序启动时创建一个 goroutine，启动定时（比如每10秒钟）任务处理 api 请求。
任务逻辑为：
1. 查询数据库 status=new 的记录
2. 遍历记录，依次发送
3. 发送成功则将 status 状态改为 finish
4. 发送失败的话等待下一个任务处理

这个实现的问题是难以扩展，当只有一个 server 时表现良好，但是：
1. 如果 server 挂了，处理中断，需要重启程序才能执行，并且可能发送重复的api请求
（在 api 请求发送成功之后，数据库操作成功之前，server挂掉）
2. 难以横向扩展，单 server 处理能力有限，多 server 情况下，轮询数据库难以处理，
会出现多个 server 同时发送同一个 api 请求的情况，虽然可以解决，但是较为繁琐

总之，可靠性和可扩展性均不足。

## 改进后的设计
在 commit 中可以看出前几个 prompt 主要是实现最初的方案。在实现过程中发现了问题，
做了进一步的改进，改进方案如下：
1. 接口的处理逻辑改为将请求的相关参数作为 message 发送给kafka，发送完成后接口即可返回
2. 启动一个goroutine，订阅消息，获取后首先在数据库查找 request_id，如果发现已经存在，
说明这个请求已经处理过了，直接忽略
3. 如果 request_id 不存在，则请求合作方接口，发送请求，成功后将 request_id 存入数据库

这样改进后，有以下优点：
1. 接口的幂等性由数据库保证，避免重复发送 api 请求
2. 可以根据 api 数量，横向扩展多个 server 处理，扩展性好
3. 即使某个 server 挂了，也不会影响其他 server 的处理，且不会丢失消息

这就是代码最终实现的方案。

由于时间有限，外加 comate licence 到期，未进行以下尝试：
1. 创建配置文件，存储 mysql 和 kafka 的相关信息
2. 创建日志文件，记录程序运行过程中的运行信息和错误信息
3. 创建监控，收集 metrics 指标，如 kafka 发送失败数、数据库操作失败数、api 发送失败数等
4. 代码结构优化，将 mysql 和 kakfa 分别封装为独立的包进行操作
5. 创建单元测试，确保代码的正确性
6. 创建 dockerfile，方便部署

## 结束
总的来说，本次考试旨在考察对微服务架构的理解和实现能力，以及对现有技术的掌握程度。
通过这次实验，我深刻理解了如何在微服务中高效、可靠地通知合作伙伴或外部系统关于业务事件，
同时也加深了对 kafka 和 mysql 的使用和理解。

## 后续工作
1. 创建配置文件，存储 mysql 和 kafka 的相关信息
2. 创建日志文件，记录程序运行过程中的运行信息和错误信息
3. 创建监控，收集 metrics 指标，如 kafka 发送失败数、数据库操作失败数、api 发送失败数等
4. 代码结构优化，将 mysql 和 kakfa 分别封装为独立的包进行操作
5. 创建单元测试，确保代码的正确性
6. 创建 dockerfile，方便部署

# 结束
本次考试主要考察 AI 编程能力，以及系统的设计能力，所以代码未做优化，仅能编译成功。
目测 AI 生成的代码逻辑符合我的要求，只是在代码组织结构和规范上还有欠缺，
但是对工作确实有很大帮助，能够加快工作进度。